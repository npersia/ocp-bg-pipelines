apiVersion: v1
items:
- apiVersion: v1
  kind: BuildConfig
  metadata:
    name: myfirstpipeline
    labels:
      name: myfirstpipeline
    annotations:
      pipeline.alpha.openshift.io/uses: '[{"name": "myphp", "namespace": "", "kind": "DeploymentConfig"}]'
  spec:
    triggers:
      -
        type: GitHub
        github:
          secret: secret101
      -
        type: Generic
        generic:
          secret: secret101
    runPolicy: Serial
    source:
      type: None
    strategy:
      type: JenkinsPipeline
      jenkinsPipelineStrategy:
          jenkinsfile: |-
            try {
               timeout(time: 20, unit: 'MINUTES') {
                  def appName="bg"
                  def project="APP_PROD"
                  def tag="blue"
                  def altTag="green"
                  def verbose="false"
          
                  node {
                    stage("BuildInQA") {
                      openshiftBuild(namespace: 'APP_QA', buildConfig: 'bg', showBuildLogs: 'true')
                    }
                    stage("DeployInQA") {
                      openshiftDeploy(namespace: 'APP_QA', deploymentConfig: 'bg')

                    }
                    stage("Initialize") {
                      sh "oc get route ${appName} -n ${project} -o jsonpath='{ .spec.to.name }' --loglevel=4 > activeservice"
                      activeService = readFile('activeservice').trim()
                      if (activeService == "${appName}-blue") {
                        tag = "green"
                        altTag = "blue"
                      }
                      sh "oc get route ${tag}-${appName} -n ${project} -o jsonpath='{ .spec.host }' --loglevel=4 > routehost"
                      routeHost = readFile('routehost').trim()
                    }

                    stage("Deploy Test") {
                      openshiftTag(namespace: 'APP_QA', sourceStream: 'bg',  sourceTag: 'latest', destinationStream: 'bg', destinationTag: 'promoteToProd')
                      openshiftDeploy(namespace: 'APP_PROD', deploymentConfig: "${appName}-${tag}")
                    }
          
                    stage("Go Live") {
                      sh "oc set -n ${project} route-backends ${appName} ${appName}-${tag}=100 ${appName}-${altTag}=0 --loglevel=4"
                    }
                  }
               }
            } catch (err) {
               echo "in catch block"
               echo "Caught: ${err}"
               currentBuild.result = 'FAILURE'
               throw err
            }          
    output:
    resources:
    postCommit:
kind: List
metadata: {}
